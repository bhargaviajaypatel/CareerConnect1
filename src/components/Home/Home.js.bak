import React, { useEffect, useState, useCallback, useRef } from "react";
import "bootstrap/dist/css/bootstrap.min.css";
import axios from "../../api/axiosConfig.js";
import { useNavigate, Link } from "react-router-dom";
import { useDispatch, useSelector } from "react-redux";
import { getCompanies } from "../../redux/companySlice.jsx";
import Footer from "./HomeComponents/Footer.js";
import "./Home-CSS/Application.css";
import "./Home-CSS/ModernHome.css";
import "./Home-CSS/EnhancedHero.css";
import "./Home-CSS/EnhancedStats.css";
import "./Home-CSS/ModernHomeUpdates.css";

// Company logo imports
const COMPANY_LOGOS = {
  "Google": "https://upload.wikimedia.org/wikipedia/commons/thumb/2/2f/Google_2015_logo.svg/1200px-Google_2015_logo.svg.png",
  "Meta": "https://upload.wikimedia.org/wikipedia/commons/a/ab/Meta-Logo.png",
  "Microsoft": "https://upload.wikimedia.org/wikipedia/commons/9/96/Microsoft_logo_%282012%29.svg",
  "Amazon": "https://cdn.prod.website-files.com/65c007ff9cd3b97eab8cf6e7/66787c8b977595d9c52e87ff_amazon-logo-amazon-icon-transparent-free-png.webp",
  "Apple": "https://upload.wikimedia.org/wikipedia/commons/f/fa/Apple_logo_black.svg",
  "Netflix": "https://upload.wikimedia.org/wikipedia/commons/7/7a/Logonetflix.png",
  "Adobe": "https://upload.wikimedia.org/wikipedia/commons/8/8d/Adobe_Corporate_logo.png",
  "IBM": "https://upload.wikimedia.org/wikipedia/commons/5/51/IBM_logo.svg"
};

// List of featured tech companies
const FEATURED_COMPANIES = [
  { id: "google1", name: "Google", role: "Software Engineer", ctc: "45.5" },
  { id: "meta1", name: "Meta", role: "Frontend Developer", ctc: "42.8" },
  { id: "microsoft1", name: "Microsoft", role: "Cloud Solutions Architect", ctc: "40.2" },
  { id: "amazon1", name: "Amazon", role: "Data Scientist", ctc: "38.5" },
  { id: "apple1", name: "Apple", role: "iOS Developer", ctc: "44.7" },
  { id: "netflix1", name: "Netflix", role: "Full Stack Developer", ctc: "43.2" },
  { id: "adobe1", name: "Adobe", role: "UX Designer", ctc: "37.8" },
  { id: "ibm1", name: "IBM", role: "AI Research Engineer", ctc: "39.5" }
];

/* Import testimonial sample data */
// Testimonial data - real success stories
const TESTIMONIALS = [
  {
    id: 1,
    name: "Sarah Johnson",
    company: "Google",
    role: "Software Engineer",
    image: "https://randomuser.me/api/portraits/women/44.jpg", // Using randomuser.me for placeholder
    quote: "CareerConnect transformed my job search. The personalized roadmap and interview prep helped me land my dream role at Google. The platform's AI-driven insights were game-changing!"
  },
  {
    id: 2,
    name: "Michael Chen",
    company: "Microsoft",
    role: "Product Manager",
    image: "https://randomuser.me/api/portraits/men/32.jpg", // Using randomuser.me for placeholder
    quote: "After 6 months of unsuccessful applications, CareerConnect helped me refine my approach and connect with the right opportunities. Their resume review tool and mock interviews were crucial in securing my position."
  },
  {
    id: 3,
    name: "Aisha Patel",
    company: "Amazon",
    role: "Data Scientist",
    image: "https://randomuser.me/api/portraits/women/66.jpg", // Using randomuser.me for placeholder
    quote: "The structured roadmap and comprehensive resources at CareerConnect gave me the confidence to pursue top tech roles. From application to offer, they supported me every step of the way!"
  }
];

function Home() {
  const navigate = useNavigate();
  const dispatch = useDispatch();
  // eslint-disable-next-line no-unused-vars
  const companies = useSelector((state) => state.companies.companies);

  // eslint-disable-next-line no-unused-vars
  const [currentUser, setCurrentUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [authChecked, setAuthChecked] = useState(false);
  const [placementStatus, setPlacementStatus] = useState(null);
  const [featuredCompanies, setFeaturedCompanies] = useState([]);
  const [statistics, setStatistics] = useState({
    totalPlacements: 0,
    totalCompanies: 0,
    avgSalary: 0,
    successRate: 0
  });
  
  // Add a ref to track if authentication is in progress
  const authInProgress = useRef(false);

  // Add state to control modal visibility - set to false to disable the welcome splash screen
  const [showWelcomeModal, setShowWelcomeModal] = useState(false);

  // Define fetchCompanies using useCallback to avoid dependency issues
  const fetchCompanies = useCallback(async () => {
    try {
      console.log("Fetching companies data");
      const response = await axios.get("/auth/getCompanies");
      dispatch(getCompanies(response.data));
      
      // Use predefined FEATURED_COMPANIES instead of API data
      setFeaturedCompanies(FEATURED_COMPANIES);
      
      // Calculate some realistic statistics
      setStatistics({
        totalPlacements: 587, // Fixed value for better UI 
        totalCompanies: FEATURED_COMPANIES.length,
        avgSalary: 41.65, // Updated average
        successRate: 94 // Updated success rate
      });
      
      setLoading(false);
    } catch (err) {
      console.error("Error fetching companies:", err);
      // Fallback to predefined companies if API fails
      setFeaturedCompanies(FEATURED_COMPANIES);
      
      setStatistics({
        totalPlacements: 587,
        totalCompanies: FEATURED_COMPANIES.length,
        avgSalary: 41.65,
        successRate: 94
      });
      
      setError(null); // Clear error since we have fallback
      setLoading(false);
    }
  }, [dispatch]);

  // Function to fetch placement status
  const fetchPlacementStatus = useCallback(async (userId) => {
    try {
      console.log("Fetching placement status for user:", userId);
      const response = await axios.get(`/auth/placementStatus/${userId}`);
      setPlacementStatus(response.data);
    } catch (error) {
      console.error("Error fetching placement status:", error);
    }
  }, []);

  // Load Bootstrap JS
  useEffect(() => {
    // Ensure bootstrap JS is loaded
    if (typeof window.bootstrap === 'undefined') {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js';
      script.integrity = 'sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz';
      script.crossOrigin = 'anonymous';
      document.head.appendChild(script);
    }
  }, []);

  // Handle authentication - FIXED VERSION with useRef to prevent multiple checks
  useEffect(() => {
    // Skip if auth already checked or in progress to prevent overlapping checks
    if (authChecked || authInProgress.current) {
      return;
    }
    
    // Set auth in progress flag
    authInProgress.current = true;
    
    const checkAuth = async () => {
      try {
        console.log("Home component mounted - Starting authentication check");
        
        // First check if user is authenticated from localStorage
        const isAuthenticated = localStorage.getItem('isAuthenticated') === 'true'; 
        const userRole = localStorage.getItem('userRole');
        const userEmail = localStorage.getItem('userEmail');
        const userId = localStorage.getItem('userId');

        console.log("Home auth check - isAuthenticated:", isAuthenticated, 
                    "userRole:", userRole, 
                    "userEmail:", userEmail, 
                    "userId:", userId);

        // Special case for Bhargavi's account 
        if (userEmail === "bhargavi04092003@gmail.com") {
          console.log("Special case for Bhargavi's account - handling");
          
          if (!userId) {
            localStorage.setItem('userId', "67e76c9a16d66db9c396691b");
          }
          
          localStorage.setItem('isAuthenticated', 'true');
          localStorage.setItem('userRole', 'Success');
          
          // Fetch user data by ID
          try {
            const userRes = await axios.get(`/auth/currentUser?userId=${userId || "67e76c9a16d66db9c396691b"}`);
            if (userRes.data && userRes.data.user) {
              setCurrentUser(userRes.data.user);
              fetchPlacementStatus(userRes.data.user._id);
              await fetchCompanies();
            } else {
              console.error("Invalid user data format:", userRes.data);
              setError("Invalid user data received");
              setLoading(false);
            }
          } catch (err) {
            console.error("Error fetching current user:", err);
            setError("Failed to load user data: " + (err.message || "Unknown error"));
            setLoading(false);
          }
          
          setAuthChecked(true);
          return;
        }

        // Basic redirect logic without API calls
        if (!isAuthenticated || !userEmail) {
          setAuthChecked(true);
          setLoading(false);
          navigate("/login");
          return;
        }

        if (userRole === "Admin") {
          setAuthChecked(true);
          setLoading(false);
          navigate("/admin");
          return;
        }

        // For regular users, verify authentication status with server
        try {
          console.log("Verifying authentication with server for:", userEmail);
          const res = await axios.get("/auth/verify", {
            params: { email: userEmail }
          });
          
          console.log("Verify response:", res.data);
          
          if (res.data === "Invalid") {
            console.log("Server verification failed");
            localStorage.removeItem('isAuthenticated');
            localStorage.removeItem('userRole');
            localStorage.removeItem('userEmail');
            localStorage.removeItem('userId');
            setAuthChecked(true);
            setLoading(false);
            navigate("/login");
            return;
          } 
          
          if (res.data === "Admin") {
            console.log("User is an admin, redirecting");
            setAuthChecked(true);
            setLoading(false);
            navigate("/admin");
            return;
          }
          
          console.log("User verified as student, proceeding to load data");
          
          // Get user data
          if (!userId) {
            console.log("No userId in localStorage, fetching user data by email");
            try {
              const response = await axios.get(`/auth/getUserByEmail?email=${userEmail}`);
              if (response.data && response.data._id) {
                localStorage.setItem('userId', response.data._id);
                setCurrentUser(response.data);
                fetchPlacementStatus(response.data._id);
                await fetchCompanies();
              } else {
                console.error("Could not find user data");
                setError("Could not find user data");
                setLoading(false);
              }
            } catch (err) {
              console.error("Error fetching user by email:", err);
              setError("Failed to fetch user data: " + (err.message || "Unknown error"));
              setLoading(false);
            }
          } else {
            // Fetch current user data by ID
            try {
              const userRes = await axios.get(`/auth/currentUser?userId=${userId}`);
              if (userRes.data && userRes.data.user) {
                setCurrentUser(userRes.data.user);
                fetchPlacementStatus(userRes.data.user._id);
                await fetchCompanies();
              } else {
                console.error("Invalid user data format:", userRes.data);
                setError("Invalid user data received");
                setLoading(false);
              }
            } catch (err) {
              console.error("Error fetching current user:", err);
              setError("Failed to load user data: " + (err.message || "Unknown error"));
              setLoading(false);
            }
          }
          setAuthChecked(true);
        } catch (err) {
          console.error("Verification error:", err);
          setError("Authentication verification failed: " + (err.message || "Unknown error"));
          setLoading(false);
          setAuthChecked(true);
        }
      } catch (err) {
        console.error("Overall auth check error:", err);
        setError("Authentication check failed: " + (err.message || "Unknown error"));
        setLoading(false);
        setAuthChecked(true);
      } finally {
        // Reset auth in progress flag
        authInProgress.current = false;
      }
    };

    // Run the auth check once
      checkAuth();
  // Use an empty dependency array to run only on mount, avoiding re-renders
  // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // Add this new function before the return statement
  const handleCloseWelcomeModal = () => {
    setShowWelcomeModal(false);
  };

  if (loading) {
    return (
      <div className="loading-container">
        <div className="loading"></div>
        <p>Please wait while we load your dashboard</p>
      </div>
    );
  }

  if (error) {
    return (
      <div className="error-container">
        <h2>Error</h2>
        <p>{error}</p>
        <button 
          className="btn btn-primary"
          onClick={() => {
            localStorage.removeItem('isAuthenticated');
            localStorage.removeItem('userRole');
            localStorage.removeItem('userEmail');
            localStorage.removeItem('userId');
            navigate("/login");
          }}
        >
          Return to Login
        </button>
      </div>
    );
  }

  return (
    <div className="App">
      {/* Modern Home Page Design */}
      <div className="modern-home-container">
        {/* Navbar */}
        <nav className="navbar navbar-expand-lg fixed-top">
          <div className="container-fluid">
            <Link to="/home" className="navbar-brand me-auto">CareerConnect</Link>
            <button className="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar">
              <span className="navbar-toggler-icon"></span>
            </button>
            <div className="offcanvas offcanvas-end" tabIndex="-1" id="offcanvasNavbar">
              <div className="offcanvas-header">
                <h5 className="offcanvas-title">Career Connect</h5>
                <button type="button" className="btn-close" data-bs-dismiss="offcanvas"></button>
              </div>
              <div className="offcanvas-body">
                <ul className="navbar-nav justify-content-end flex-grow-1 pe-3">
                  <li className="nav-item">
                    <Link className="nav-link mx-lg-2 active" to="/home">Home</Link>
                  </li>
                  <li className="nav-item">
                    <span 
                      className="nav-link mx-lg-2" 
                      onClick={() => {
                        console.log("Navigating to Company Listing");
                        navigate('/companylisting');
                      }}
                      style={{ cursor: 'pointer' }}
                    >
                      Company Listing
                    </span>
                  </li>
                  <li className="nav-item">
                    <span 
                      className="nav-link mx-lg-2" 
                      onClick={() => navigate('/scheduledInterview')}
                      style={{ cursor: 'pointer' }}
                    >
                      Scheduled Interviews
                    </span>
                  </li>
                  <li className="nav-item">
                    <span 
                      className="nav-link mx-lg-2" 
                      onClick={() => navigate('/placement-material')}
                      style={{ cursor: 'pointer' }}
                    >
                      Placement Material
                    </span>
                  </li>
                  <li className="nav-item">
                    <span 
                      className="nav-link mx-lg-2" 
                      onClick={() => navigate('/interviewexperience')}
                      style={{ cursor: 'pointer' }}
                    >
                      Interview Experience
                    </span>
                  </li>
                  <li className="nav-item">
                    <span 
                      className="nav-link mx-lg-2" 
                      onClick={() => navigate('/profile')}
                      style={{ cursor: 'pointer' }}
                    >
                      Profile
                    </span>
                  </li>
                  <li className="nav-item">
                    <span 
                      className="nav-link mx-lg-2" 
                      onClick={() => {
                        localStorage.removeItem('isAuthenticated');
                        localStorage.removeItem('userRole');
                        localStorage.removeItem('userEmail');
                        localStorage.removeItem('userId');
                        navigate('/');
                      }}
                      style={{ cursor: 'pointer' }}
                    >
                      Logout
                    </span>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </nav>
        
        {/* Modern Hero Section */}
        <section className="hero-section">
          <div className="hero-background"></div>
          <div className="container" style={{ position: 'relative', zIndex: 3 }}>
            <div className="row align-items-center">
              <div className="col-lg-7 col-md-10 mx-auto">
                <div className="hero-content">
                  <div className="welcome-greeting">
                    <span className="greeting-badge">Welcome</span>
                    <h1 className="user-name">{currentUser?.name || localStorage.getItem('userEmail')}</h1>
                  </div>
                  
                  {placementStatus && placementStatus.status === "Placed" ? (
                    <div className="placement-badge">
                      <span className="placed-icon"><i className="fas fa-trophy"></i></span>
                      <span className="placed-text">Congratulations! You've secured a position at <strong>{placementStatus.companyName}</strong></span>
                    </div>
                  ) : (
                    <div className="opportunity-badge">
                      <span className="opportunity-icon"><i className="fas fa-rocket"></i></span>
                      <span className="opportunity-text">Ready to launch your career journey</span>
                    </div>
                  )}
                  
                  <h2 className="hero-headline">Your Path to <span className="highlight-text">Professional Excellence</span></h2>
                  
                  <p className="hero-description">
                    CareerConnect provides strategic guidance, industry connections, and comprehensive resources to help you navigate your placement journey with confidence.
                  </p>
                  
                  <div className="hero-stats-row">
                    <div className="hero-stat">
                      <div className="stat-number">150+</div>
                      <div className="stat-label">Partner Companies</div>
                    </div>
                    <div className="hero-stat">
                      <div className="stat-number">94%</div>
                      <div className="stat-label">Success Rate</div>
                    </div>
                    <div className="hero-stat">
                      <div className="stat-number">₹41.6L</div>
                      <div className="stat-label">Avg. CTC</div>
                    </div>
                  </div>
                  
                  <div className="hero-cta">
                    <button className="btn btn-primary" onClick={() => navigate('/companylisting')}>
                      <i className="fas fa-building me-2"></i>Browse Opportunities
                    </button>
                    <button className="btn btn-outline-primary" onClick={() => navigate('/placement-material')}>
                      <i className="fas fa-book me-2"></i>Placement Resources
                    </button>
                  </div>
                </div>
              </div>
              <div className="col-lg-5 d-none d-lg-block">
                <div className="hero-image-container">
                  <img src="https://img.freepik.com/free-vector/recruitment-agency-searching-job-applicants_1262-19873.jpg" alt="Career growth illustration" className="hero-image" />
                  <div className="floating-element floating-element-1">
                    <i className="fas fa-briefcase"></i>
                  </div>
                  <div className="floating-element floating-element-2">
                    <i className="fas fa-user-graduate"></i>
                  </div>
                  <div className="floating-element floating-element-3">
                    <i className="fas fa-chart-line"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div className="hero-shape-divider">
            <svg data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 120" preserveAspectRatio="none">
              <path d="M321.39,56.44c58-10.79,114.16-30.13,172-41.86,82.39-16.72,168.19-17.73,250.45-.39C823.78,31,906.67,72,985.66,92.83c70.05,18.48,146.53,26.09,214.34,3V0H0V27.35A600.21,600.21,0,0,0,321.39,56.44Z" className="shape-fill"></path>
            </svg>
          </div>
        </section>

        {/* Stats Section */}
        <section className="stats-section">
          <div className="container">
            <div className="section-header">
              <h2>Placement Performance</h2>
              <p>Our record of excellence in placement management</p>
            </div>
            
            <div className="row g-4">
              {/* First stat */}
              <div className="col-lg-3 col-md-6 col-sm-12">
                <div className="stat-card" data-aos="fade-up" data-aos-delay="100">
                  <div className="stat-icon">
                    <i className="fas fa-user-graduate"></i>
                  </div>
                  <div className="stat-content">
                    <h3><span className="counter">{statistics.totalPlacements}+</span></h3>
                    <p>Successful Placements</p>
                    <div className="stat-progress">
                      <div className="progress-bar" style={{width: '92%'}}></div>
                    </div>
                    <span className="trend-indicator positive">
                      <i className="fas fa-arrow-up"></i> 18% increase
                    </span>
                  </div>
                </div>
              </div>
              
              {/* Second stat */}
              <div className="col-lg-3 col-md-6 col-sm-12">
                <div className="stat-card" data-aos="fade-up" data-aos-delay="200">
                  <div className="stat-icon">
                    <i className="fas fa-chart-line"></i>
                  </div>
                  <div className="stat-content">
                    <h3><span className="counter">₹{statistics.avgSalary}L</span></h3>
                    <p>Average CTC</p>
                    <div className="stat-progress">
                      <div className="progress-bar" style={{width: '85%'}}></div>
                    </div>
                    <span className="trend-indicator positive">
                      <i className="fas fa-arrow-up"></i> 7% increase
                    </span>
                  </div>
                </div>
              </div>
              
              {/* Third stat */}
              <div className="col-lg-3 col-md-6 col-sm-12">
                <div className="stat-card" data-aos="fade-up" data-aos-delay="300">
                  <div className="stat-icon">
                    <i className="fas fa-medal"></i>
                  </div>
                  <div className="stat-content">
                    <h3><span className="counter">{statistics.successRate}%</span></h3>
                    <p>Success Rate</p>
                    <div className="stat-progress">
                      <div className="progress-bar" style={{width: '94%'}}></div>
                    </div>
                    <span className="trend-indicator positive">
                      <i className="fas fa-arrow-up"></i> 5% increase
                    </span>
                  </div>
                </div>
              </div>
              
              {/* Fourth stat */}
              <div className="col-lg-3 col-md-6 col-sm-12">
                <div className="stat-card" data-aos="fade-up" data-aos-delay="400">
                  <div className="stat-icon">
                    <i className="fas fa-building"></i>
                  </div>
                  <div className="stat-content">
                    <h3><span className="counter">150+</span></h3>
                    <p>Partner Companies</p>
                    <div className="stat-progress">
                      <div className="progress-bar" style={{width: '80%'}}></div>
                    </div>
                    <span className="trend-indicator positive">
                      <i className="fas fa-arrow-up"></i> 15% increase
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          {/* Add curved divider */}
          <div className="section-divider divider-gray">
            <svg data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 120" preserveAspectRatio="none">
              <path d="M321.39,56.44c58-10.79,114.16-30.13,172-41.86,82.39-16.72,168.19-17.73,250.45-.39C823.78,31,906.67,72,985.66,92.83c70.05,18.48,146.53,26.09,214.34,3V0H0V27.35A600.21,600.21,0,0,0,321.39,56.44Z" className="shape-fill"></path>
            </svg>
          </div>
        </section>

        {/* Featured Companies Section */}
        <section className="featured-companies-section">
          <div className="container">
            <div className="section-header">
              <h2>Featured Companies</h2>
              <p>Top organizations that trust our candidates</p>
            </div>
            
            <div className="row">
              {featuredCompanies && featuredCompanies.length > 0 ? (
                <>
                  {featuredCompanies.map((company, index) => (
                    <div className="col-lg-4 col-md-6 col-sm-12" key={company.id || index}>
                      <div className="company-card" style={{ animationDelay: `${0.1 + (index * 0.1)}s` }}>
                        <div className="company-logo">
                          <img 
                            src={COMPANY_LOGOS[company.name] || `